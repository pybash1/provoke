<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provoke Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: '#0a0a0c',
                        surface: '#121217',
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        'text-dim': '#94a3b8',
                        border: 'rgba(255, 255, 255, 0.08)',
                        glass: 'rgba(255, 255, 255, 0.03)',
                    },
                    fontFamily: {
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                @apply bg-bg text-[#e2e8f0] font-mono leading-relaxed min-h-screen p-8;
            }
            * {
                @apply rounded-none;
            }
        }
        @layer components {
            .stat-card {
                @apply bg-surface border border-border p-5 relative overflow-hidden transition-all duration-200 hover:-translate-y-1 hover:border-primary;
            }
            .section-box {
                @apply bg-surface border border-border px-6 pt-6 h-full;
            }
            .btn-primary {
                @apply bg-primary text-white px-5 py-2.5 font-semibold cursor-pointer transition-all duration-200 hover:brightness-110 disabled:opacity-50 disabled:cursor-not-allowed;
            }
            .input-field {
                @apply bg-bg border border-border px-4 py-2 text-white font-mono outline-none focus:border-primary;
            }
            .tier-badge {
                @apply px-2.5 py-0.5 font-bold uppercase text-[0.65rem];
            }
        }
        /* Custom scrollbar for logs */
        #crawl-logs::-webkit-scrollbar {
            width: 4px;
        }
        #crawl-logs::-webkit-scrollbar-thumb {
            @apply bg-border;
        }
    </style>
</head>

<body>
    <div class="max-w-[1400px] mx-auto">
        <header class="flex justify-between items-center mb-12">
            <h1 class="text-4xl font-bold tracking-tight text-white">Provoke Admin</h1>
            <nav class="flex gap-6 items-center">
                <a href="/" class="font-semibold text-text-dim hover:text-white transition-colors text-sm">← Search</a>
                <a href="/domains" class="font-semibold text-text-dim hover:text-white transition-colors text-sm">Domain
                    Explorer</a>
                <a href="/admin/lists"
                    class="font-semibold text-text-dim hover:text-white transition-colors text-sm">Manage Lists</a>
                <a href="/admin/label"
                    class="font-semibold text-text-dim hover:text-white transition-colors text-sm">Data Labeler</a>
                <a href="/admin/manual_insert"
                    class="font-semibold text-white px-3 py-1 bg-primary/20 hover:bg-primary/30 transition-all text-sm border border-primary/30">Manual
                    Insert</a>
            </nav>
        </header>

        {% if request.args.get('success') %}
        <div
            class="mb-8 p-4 bg-success/10 border border-success text-success text-sm font-bold flex justify-between items-center">
            <span>{{ request.args.get('success') }}</span>
            <button onclick="this.parentElement.remove()" class="text-success hover:brightness-125">✕</button>
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-12">
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Accepted Pages
                </div>
                <div id="total-pages" class="text-3xl font-bold text-white">{{ total_pages }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Crawl Efficiency: <span id="efficiency">{{ efficiency
                        }}</span>%</div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Rejected Pages
                </div>
                <div id="total-rejected" class="text-3xl font-bold text-white">{{ total_rejected }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Avg Rej. Words: <span id="avg-rejected-wc">{{
                        avg_rejected_wc }}</span></div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Lists Managed
                </div>
                <div class="text-2xl font-bold text-white my-2">
                    B: {{ total_blacklisted }} &nbsp; A: {{ total_whitelisted }}
                </div>
                <div class="text-[0.7rem] text-text-dim"><a href="/admin/lists" class="text-primary no-underline">Manage
                        Lists →</a></div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Labeling Progress
                </div>
                <div class="flex justify-between items-baseline mb-1">
                    <div id="labeling-progress-text"
                        class="text-3xl font-bold {% if labeling_progress | float >= 80 %}text-success{% elif labeling_progress | float >= 40 %}text-warning{% else %}text-danger{% endif %}">
                        {{ labeling_progress }}%
                    </div>
                    <div class="text-[0.7rem] text-text-dim">
                        <span id="done-labels">{{ done_labels }}</span> done,
                        <span id="pending-labels">{{ pending_labels }}</span> pending
                    </div>
                </div>
                <div class="bg-white/5 h-2 overflow-hidden">
                    <div id="labeling-progress-bar" class="bg-primary h-full transition-all duration-500"
                        style="width: {{ labeling_progress }}%;"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-12">
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Avg Word Count
                </div>
                <div id="avg-wc" class="text-3xl font-bold text-white">{{ avg_wc }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Accepted Pages Only</div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Avg Readability
                </div>
                <div id="avg-readability" class="text-3xl font-bold text-white">{{ avg_readability }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Higher is Easier</div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Avg Text/HTML
                </div>
                <div id="avg-tr" class="text-3xl font-bold text-white">{{ avg_tr }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Content Density</div>
            </div>
            <div class="stat-card">
                <div class="text-[0.75rem] font-semibold text-text-dim uppercase tracking-wider mb-2">Avg Unified Score
                </div>
                <div id="avg-unified" class="text-3xl font-bold text-success">{{ avg_unified }}</div>
                <div class="text-[0.7rem] text-text-dim mt-1">Overall Quality</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 section-box">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">Actions & Active Tracking</h2>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="crawl-url" placeholder="https://example.com" class="input-field flex-1">
                    <select id="crawl-depth" class="input-field">
                        <option value="1">Depth 1</option>
                        <option value="2">Depth 2</option>
                        <option value="3">Depth 3</option>
                    </select>
                    <button onclick="startCrawl(event)" class="btn-primary">Crawl</button>
                </div>
                <div id="crawl-logs"
                    class="bg-black p-4 font-mono text-[0.75rem] max-h-[200px] overflow-y-auto text-[#31ed31] border border-border mt-4 hidden">
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4 text-white">Quality Breakdown</h3>
                    <div class="relative h-[200px] w-full">
                        <canvas id="tierChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section-box">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">Top Domains</h2>
                <div class="relative h-[380px] w-full">
                    <canvas id="domainChart"></canvas>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="section-box">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">Rejection Breakdown</h2>
                <div class="relative h-[300px] w-full">
                    <canvas id="rejectionChart"></canvas>
                </div>
            </div>

            <div class="section-box">
                <h2 class="text-xl font-semibold mb-6 flex items-center gap-3">Quality Tester (Dry Run)</h2>
                <p class="text-text-dim text-[0.8rem] mb-4">
                    Test how the quality model would classify a URL without indexing it.
                </p>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="test-url" placeholder="https://example.com/blog" class="input-field flex-1">
                    <button onclick="testURL()" class="btn-primary" id="test-btn">Test</button>
                </div>
                <div id="test-result"
                    class="hidden mt-4 p-4 bg-glass border border-border max-h-[300px] overflow-y-auto">
                    <div class="flex justify-between items-start mb-3">
                        <div class="max-w-[70%]">
                            <h4 id="test-title"
                                class="text-[0.95rem] leading-tight overflow-hidden text-ellipsis whitespace-nowrap text-white font-semibold">
                            </h4>
                            <div id="test-final-url" class="text-[0.65rem] text-text-dim overflow-hidden text-ellipsis">
                            </div>
                        </div>
                        <div id="test-tier-badge" class="tier-badge"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-black/20 p-2">
                            <div class="text-[0.6rem] text-text-dim uppercase font-bold">Score</div>
                            <div id="test-score" class="text-lg font-bold text-primary"></div>
                        </div>
                        <div class="bg-black/20 p-2">
                            <div class="text-[0.6rem] text-text-dim uppercase font-bold">Words</div>
                            <div id="test-wc" class="text-lg font-bold text-white"></div>
                        </div>
                    </div>

                    <div id="test-rejection-box" class="hidden mb-4">
                        <h5 class="text-danger text-[0.75rem] uppercase font-bold mb-1">Rejection:</h5>
                        <ul id="test-reasons" class="list-none text-[0.75rem] text-white"></ul>
                    </div>

                    <div id="test-all-scores" class="grid grid-cols-2 sm:grid-cols-3 gap-2 border-t border-border pt-3">
                    </div>
                </div>
            </div>
        </div>

        <section class="section-box px-0">
            <h2 class="text-xl font-semibold mb-6 px-6">Recent Activity</h2>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse text-[0.875rem]">
                    <thead>
                        <tr class="text-left border-b border-border px-6">
                            <th class="p-3 text-text-dim font-semibold uppercase text-[0.75rem]">Page Info</th>
                            <th class="p-3 text-text-dim font-semibold uppercase text-[0.75rem]">Unified Score</th>
                            <th class="p-3 text-text-dim font-semibold uppercase text-[0.75rem]">Quality Tier</th>
                            <th class="p-3 text-text-dim font-semibold uppercase text-[0.75rem]">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recent-pages-body">
                        {% for page in recent_pages %}
                        <tr class="border-b border-border hover:bg-white/5 transition-colors px-6">
                            <td class="p-3">
                                <div class="font-semibold text-[0.85rem] mb-0.5">
                                    <a href="{{ page.url }}" target="_blank"
                                        class="text-white no-underline hover:text-primary line-clamp-1">{{ page.title or
                                        'Untitled'
                                        }}</a>
                                </div>
                                <div
                                    class="text-[0.65rem] text-text-dim max-w-[400px] overflow-hidden text-ellipsis whitespace-nowrap">
                                    {{ page.url }}
                                </div>
                            </td>
                            <td class="p-3 font-mono font-bold text-base"
                                style="color: {% if page.score | float >= 75 %}#10b981{% elif page.score | float >= 55 %}#f59e0b{% else %}#ef4444{% endif %};">
                                {{ page.score }}
                            </td>
                            <td class="p-3">
                                <span
                                    class="tier-badge px-2.5 py-0.5 font-bold uppercase text-[0.65rem] {% if page.tier == 'high' %}bg-success/10 text-success{% elif page.tier == 'medium' %}bg-warning/10 text-warning{% else %}bg-danger/10 text-danger{% endif %}">{{
                                    page.tier }}</span>
                            </td>
                            <td class="p-3">
                                <form action="/admin/delete_page" method="POST"
                                    onsubmit="return confirm('Delete this page?')">
                                    <input type="hidden" name="url" value="{{ page.url }}">
                                    <button type="submit"
                                        class="text-danger hover:bg-danger/10 p-1.5 transition-all duration-200">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const colors = {
            primary: '#6366f1',
            secondary: '#ec4899',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            surface: '#1e293b',
            chart: [
                'rgba(99, 102, 241, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(16, 185, 129, 0.7)',
                'rgba(245, 158, 11, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)'
            ]
        };

        const rejectionCtx = document.getElementById('rejectionChart').getContext('2d');
        const rejectionChart = new Chart(rejectionCtx, {
            type: 'bar',
            data: {
                labels: {{ rejection_labels | tojson }},
        datasets: [{
            data: {{ rejection_values | tojson }},
            backgroundColor: colors.chart,
            borderRadius: 0
                }]
            },
        options: {
            indexAxis: 'y',
                responsive: true,
                    maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                y: { grid: { display: false }, ticks: { color: '#e2e8f0' } }
            }
        }
        });

        const tierCtx = document.getElementById('tierChart').getContext('2d');
        const tierChart = new Chart(tierCtx, {
            type: 'doughnut',
            data: {
                labels: {{ tier_labels | tojson }},
        datasets: [{
            data: {{ tier_values | tojson }},
            backgroundColor: [colors.success, colors.warning, colors.danger],
            borderWidth: 0,
            cutout: '70%'
                }]
            },
        options: {
            responsive: true,
                maintainAspectRatio: false,
                    plugins: {
                legend: { position: 'right', labels: { color: '#e2e8f0', usePointStyle: true } }
            }
        }
        });

        const domainCtx = document.getElementById('domainChart').getContext('2d');
        const domainChart = new Chart(domainCtx, {
            type: 'bar',
            data: {
                labels: {{ top_domains_labels | tojson }},
        datasets: [{
            data: {{ top_domains_values | tojson }},
            backgroundColor: colors.primary + '88',
            borderColor: colors.primary,
            borderWidth: 1,
            borderRadius: 0
                }]
            },
        options: {
            indexAxis: 'y',
                responsive: true,
                    maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                y: { grid: { display: false }, ticks: { color: '#e2e8f0' } }
            }
        }
        });

        async function updateStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                document.getElementById('total-pages').innerText = data.total_pages;
                document.getElementById('total-rejected').innerText = data.total_rejected;
                document.getElementById('efficiency').innerText = data.efficiency;
                document.getElementById('avg-rejected-wc').innerText = data.avg_rejected_wc;
                const progressText = document.getElementById('labeling-progress-text');
                const progress = data.labeling_progress;
                progressText.innerText = progress + '%';

                // Update progress color
                progressText.classList.remove('text-white', 'text-success', 'text-warning', 'text-danger');
                if (progress >= 80) progressText.classList.add('text-success');
                else if (progress >= 40) progressText.classList.add('text-warning');
                else progressText.classList.add('text-danger');

                document.getElementById('labeling-progress-bar').style.width = progress + '%';
                document.getElementById('done-labels').innerText = data.done_labels;
                document.getElementById('pending-labels').innerText = data.pending_labels;
                document.getElementById('avg-wc').innerText = data.avg_wc;
                document.getElementById('avg-readability').innerText = data.avg_readability;
                document.getElementById('avg-tr').innerText = data.avg_tr;
                document.getElementById('avg-unified').innerText = data.avg_unified;

                rejectionChart.data.labels = data.rejection_labels;
                rejectionChart.data.datasets[0].data = data.rejection_values;
                rejectionChart.update();
                tierChart.data.datasets[0].data = data.tier_values;
                tierChart.update();
                domainChart.data.labels = data.top_domains_labels;
                domainChart.data.datasets[0].data = data.top_domains_values;
                domainChart.update();
            } catch (error) { console.error('Error:', error); }
        }

        async function testURL() {
            const url = document.getElementById('test-url').value.trim();
            const btn = document.getElementById('test-btn');
            const resultBox = document.getElementById('test-result');
            if (!url) return alert('Enter a URL to test');
            btn.disabled = true;
            btn.innerText = 'Testing...';
            try {
                const response = await fetch(`/admin/test_url?url=${encodeURIComponent(url)}`);
                const data = await response.json();
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                resultBox.classList.remove('hidden');
                document.getElementById('test-title').innerText = data.title || 'Untitled';
                document.getElementById('test-final-url').innerText = data.url;
                const tierBadge = document.getElementById('test-tier-badge');
                tierBadge.innerText = data.quality_tier;
                tierBadge.className = `tier-badge font-bold uppercase text-[0.65rem] px-2.5 py-0.5 `;
                if (data.quality_tier === 'high') tierBadge.classList.add('bg-success/10', 'text-success');
                else if (data.quality_tier === 'medium') tierBadge.classList.add('bg-warning/10', 'text-warning');
                else tierBadge.classList.add('bg-danger/10', 'text-danger');

                const scoreEl = document.getElementById('test-score');
                const score = data.scores.unified_score || 0;
                scoreEl.innerText = score;
                if (score >= 80) scoreEl.style.color = colors.success;
                else if (score >= 40) scoreEl.style.color = colors.warning;
                else scoreEl.style.color = colors.danger;
                document.getElementById('test-wc').innerText = data.scores.word_count || 0;
                const rejectionBox = document.getElementById('test-rejection-box');
                const reasonsList = document.getElementById('test-reasons');
                if (data.rejection_reasons && data.rejection_reasons.length > 0) {
                    rejectionBox.classList.remove('hidden');
                    reasonsList.innerHTML = data.rejection_reasons.map(r => `<li style="margin-bottom: 0.2rem;">• ${r}</li>`).join('');
                } else {
                    rejectionBox.classList.add('hidden');
                }
                const allScoresDiv = document.getElementById('test-all-scores');
                allScoresDiv.innerHTML = Object.entries(data.scores)
                    .filter(([k]) => !['unified_score', 'word_count'].includes(k))
                    .map(([k, v]) => [k, typeof v === "string" ? v.replace("(ML prediction only)", "") : v])
                    .map(([k, v]) => `<div><div class="text-[0.6rem] text-text-dim uppercase">${k.replaceAll('_', ' ')}</div><div class="text-xs font-bold">${typeof v === 'number' ? v.toFixed(2) : v}</div></div>`)
                    .join('');
            } catch (e) {
                console.error(e);
                alert('Connection error');
            } finally {
                btn.disabled = false;
                btn.innerText = 'Test';
            }
        }

        async function startCrawl() {
            const urlInput = document.getElementById('crawl-url');
            const url = urlInput.value.trim();
            const depth = document.getElementById('crawl-depth').value;
            const logsDiv = document.getElementById('crawl-logs');
            const btn = event.target;

            if (!url) return alert('Enter URL');

            btn.disabled = true;
            logsDiv.classList.remove('hidden');
            logsDiv.innerHTML = '<div class="text-text-dim italic">Initializing crawl process...</div>';

            try {
                const response = await fetch(`/admin/crawl?url=${encodeURIComponent(url)}&depth=${depth}`);
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let partial = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = (partial + chunk).split('\n');
                    partial = lines.pop(); // Last one might be partial

                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const div = document.createElement('div');
                        div.className = 'mb-0.5';

                        // Color coding
                        if (line.includes('Accepted')) {
                            div.style.color = colors.success;
                            div.innerText = '[OK] ' + line;
                        } else if (line.includes('Rejected')) {
                            div.style.color = colors.danger;
                            div.innerText = '[REJECTED] ' + line;
                        } else if (line.includes('!!!')) {
                            div.style.color = colors.warning;
                            div.style.fontWeight = '700';
                            div.innerText = '[WARNING] ' + line;
                        } else {
                            div.innerText = line;
                        }

                        logsDiv.appendChild(div);
                        logsDiv.scrollTop = logsDiv.scrollHeight;

                        if (line.includes('[CRAWL COMPLETE]')) {
                            updateStats();
                            setTimeout(() => {
                                logsDiv.classList.add('hidden');
                                logsDiv.innerHTML = '';
                            }, 5000);
                        }
                    });
                }
            } catch (e) {
                logsDiv.innerHTML += `<div class="text-danger mt-3 font-bold">Connection Error: ${e}</div>`;
            } finally {
                btn.disabled = false;
            }
        }

        setInterval(updateStats, 15000);
    </script>
</body>

</html>